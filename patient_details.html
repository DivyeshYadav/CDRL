<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report Editor</title>
    <style>
        @page {
            size: A4;
            margin: 15mm;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
            color: #1a73e8;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 25px;
            margin-bottom: 25px;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
        }

        .info-item span:first-child {
            font-weight: 500;
            color: #555;
        }

        .info-item span:last-child {
            font-weight: bold;
            color: #333;
        }

        .subtest-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .subtest-table th,
        .subtest-table td {
            border: 1px solid #dcdcdc;
            padding: 8px;
            vertical-align: top;
        }

        .subtest-table th {
            background: #eaf1fb;
            font-weight: bold;
            text-align: left;
        }

        .subtest-name-cell {
            font-weight: 600;
            background: #f7f9fc;
            cursor: text;
        }

        .subtest-name-cell:focus {
            outline: 2px solid #1a73e8;
            background: #fff;
        }

        .edit-area {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 14px;
            outline: none;
            resize: vertical;
            min-height: 40px;
            background: #fff;
        }

        .print-result {
            display: none;
        }

        .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-add-row {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-save {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-print {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .message-box {
            background: #ffc107;
            color: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .top-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        /* ‚úÖ Updated Footer Styling */
        .report-footer {
            margin-top: 30px;
            font-size: 14px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }

        .footer-signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .signature-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .signature-label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .signature-content {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .signature-content select {
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
            width: 100%;
            max-width: 200px;
        }

        .signature-content img {
            width: 120px;
            max-height: 40px;
            object-fit: contain;
            display: none;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .btn-row,
            .top-buttons,
            .edit-area,
            .signature-content select {
                display: none !important;
            }

            .print-result {
                display: block !important;
                white-space: pre-wrap;
                font-size: 14px;
                padding: 4px 0;
                margin: 0;
                min-height: 1.4em;
            }

            .subtest-table tr:has(.print-result:empty) {
                display: none;
            }

            .subtest-table td {
                border-color: #555 !important;
            }

            .signature-content img {
                display: block !important;
            }

            /* Ensure both signatures appear left-aligned in print */
            .footer-signatures {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="messageBox" class="message-box"></div>
        <div class="top-buttons">
            <button class="btn-back" onclick="goToDashboard()">‚Üê Back to Dashboard</button>
            <button class="btn-print" onclick="prepareAndPrint()">üñ®Ô∏è Print Report</button>
        </div>

        <h1>Patient Report Editor</h1>

        <div class="info-grid">
            <div class="info-item"><span>Patient Name:</span><span id="patientName">---</span></div>
            <div class="info-item"><span>Sample ID:</span><span id="sampleId">---</span></div>
            <div class="info-item"><span>Age/Gender:</span><span id="ageGender">---</span></div>
            <div class="info-item"><span>Contact No:</span><span id="contact">---</span></div>
            <div class="info-item"><span>Referred By:</span><span id="referredBy">---</span></div>
            <div class="info-item"><span>Test Name:</span><span id="testName">---</span></div>
            <div class="info-item"><span>Collection Date:</span><span id="collectionDate">---</span></div>
            <div class="info-item"><span>Report Date:</span><span id="reportDate">---</span></div>
        </div>

        <table class="subtest-table">
            <thead>
                <tr>
                    <th>Sub Test</th>
                    <th>Result/Finding</th>
                </tr>
            </thead>
            <tbody id="subtestBody"></tbody>
        </table>

        <div class="btn-row">
            <button class="btn-add-row" onclick="addRow()">+ Add New Row</button>
            <button class="btn-save" onclick="saveReport()">üíæ Save Report</button>
        </div>

        <!-- ‚úÖ Updated Footer -->
        <div class="report-footer">
            <div class="footer-signatures">
                <div class="signature-block">
                    <div class="signature-label">
                        <div class="signature-label">Report Checked By</div>
                        <div class="signature-content">
                            <select id="reportCheckedBy" onchange="toggleSignature()">
                                <option value="">-- Select Doctor --</option>
                                <option value="Dr. Alina Tiwari">Dr. Alina Tiwari</option>
                            </select>
                            <img id="signatureImage" src="Signature.jpg" alt="Signature">
                        </div>
                        <div class="signature-content">
                            <div>Dr. Alina Tiwari</div>
                            <div>Consultant Pathalogist</div>
                            <div>NMC No: 23690</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedPatient = null;
        let patientId = null;

        function displayMessage(msg) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 4000);
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function toggleSignature() {
            const doctor = document.getElementById("reportCheckedBy").value;
            document.getElementById("signatureImage").style.display = doctor ? "block" : "none";
        }

        function addRow(name = "New Sub Test", value = "") {
            const tbody = document.getElementById('subtestBody');
            const row = tbody.insertRow();

            const nameCell = row.insertCell();
            nameCell.className = 'subtest-name-cell';
            nameCell.contentEditable = true;
            nameCell.textContent = name;

            const resultCell = row.insertCell();
            resultCell.innerHTML = `
                <textarea class="edit-area" placeholder="Enter result">${value}</textarea>
                <div class="print-result">${value}</div>
            `;
        }

        function syncPrintViews() {
            document.querySelectorAll('#subtestBody tr').forEach(row => {
                const textarea = row.querySelector('.edit-area');
                const printDiv = row.querySelector('.print-result');
                if (textarea && printDiv) {
                    printDiv.textContent = textarea.value;
                }
            });
        }

        function saveReport() {
            syncPrintViews();

            const rows = document.querySelectorAll("#subtestBody tr");
            const subtests = {};
            rows.forEach(row => {
                const name = row.cells[0].textContent.trim();
                const value = row.querySelector('.edit-area').value.trim();
                if (name) {
                    subtests[name] = { value };
                }
            });

            const checkedBy = document.getElementById('reportCheckedBy').value;
            const reportDate = new Date().toISOString().split('T')[0];

            // Save to localStorage using patientId as key
            if (patientId) {
                localStorage.setItem(`subtests_${patientId}`, JSON.stringify(subtests));
                localStorage.setItem(`checkedBy_${patientId}`, checkedBy);
                localStorage.setItem(`reportDate_${patientId}`, reportDate);

                // Also update the main patient object
                selectedPatient = {
                    ...selectedPatient,
                    subtestData: subtests,
                    checkedBy,
                    reportDate
                };
                localStorage.setItem("selectedPatient", JSON.stringify(selectedPatient));

                displayMessage("Report saved successfully!");
            } else {
                displayMessage("Error: No patient ID found for saving");
            }
        }

        function prepareAndPrint() {
            syncPrintViews();

            const hasContent = Array.from(document.querySelectorAll('.print-result'))
                .some(div => div.textContent.trim() !== '');

            if (!hasContent) {
                displayMessage("‚ö†Ô∏è No results entered. Nothing to print.");
                return;
            }

            window.print();
        }

        function loadPatient() {
            const stored = localStorage.getItem("selectedPatient");
            selectedPatient = stored ? JSON.parse(stored) : {
                firstName: "John",
                lastName: "Doe",
                age: "30",
                sex: "Male",
                contact: "",
                referredBy: "",
                testName: "",
                sampleNumber: "S-001",
                dateCollected: "2025-11-10",
                reportDate: "2025-11-17",
                subtestData: {
                    "Chief Complaint": { value: "" },
                    "USG Findings": { value: "" },
                    "Gross": { value: "" },
                    "Microscopy": { value: "" },
                    "Impression": { value: "" }
                }
            };

            // Get patient ID from sample number or create a fallback
            patientId = selectedPatient.sampleNumber || selectedPatient.id || 'default';

            // Load subtests from localStorage if available
            const storedSubtests = localStorage.getItem(`subtests_${patientId}`);
            const storedCheckedBy = localStorage.getItem(`checkedBy_${patientId}`);
            const storedReportDate = localStorage.getItem(`reportDate_${patientId}`);

            if (storedSubtests) {
                selectedPatient.subtestData = JSON.parse(storedSubtests);
            }
            if (storedCheckedBy) {
                selectedPatient.checkedBy = storedCheckedBy;
            }
            if (storedReportDate) {
                selectedPatient.reportDate = storedReportDate;
            }

            document.getElementById("patientName").textContent = `${selectedPatient.firstName} ${selectedPatient.lastName}`;
            document.getElementById("ageGender").textContent = `${selectedPatient.age} / ${selectedPatient.sex}`;
            document.getElementById("contact").textContent = selectedPatient.contact || "---";
            document.getElementById("referredBy").textContent = selectedPatient.referredBy || "---";
            document.getElementById("testName").textContent = selectedPatient.testName || "---";
            document.getElementById("collectionDate").textContent = selectedPatient.dateCollected || "---";
            document.getElementById("reportDate").textContent = selectedPatient.reportDate || "---";
            document.getElementById("sampleId").textContent = selectedPatient.sampleNumber || "---";
            document.getElementById("reportCheckedBy").value = selectedPatient.checkedBy || "";
            toggleSignature();

            const tbody = document.getElementById('subtestBody');
            tbody.innerHTML = '';
            const subtests = selectedPatient.subtestData || {};
            for (const [name, data] of Object.entries(subtests)) {
                addRow(name, data.value || "");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPatient();

            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('edit-area')) {
                    const printDiv = e.target.parentElement.querySelector('.print-result');
                    if (printDiv) printDiv.textContent = e.target.value;
                }
            });
        });
    </script>
</body>

</html>