=<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- General Layout and Print Styles --- */
        @page { size: A4; margin: 15mm; }
        body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, .1); }
        h1 { text-align: center; margin-bottom: 25px; font-size: 24px; color: #1a73e8; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .histopathalogy-header { text-align: center; margin: 20px 0 15px 0; font-size: 18px; color: #1a73e8; border-bottom: 1px solid #ddd; padding-bottom: 8px; font-weight: bold; }

        /* --- Patient Info Grid Layout --- */
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px 25px; margin-bottom: 25px; font-size: 14px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px dotted #ccc; }
        .info-item span:first-child { font-weight: 500; color: #555; }
        .info-item span:last-child { font-weight: bold; color: #333; }

        /* --- Report Table Styles --- */
        .subtest-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .subtest-table th, .subtest-table td { border: 1px solid #dcdcdc; padding: 8px; vertical-align: top; }
        .subtest-table th { background: #eaf1fb; font-weight: bold; text-align: left; }
        .subtest-name-cell { font-weight: 600; background: #f7f9fc; cursor: text; width: 30%; }
        .edit-area { width: 100%; border: none; padding: 4px; font-size: 14px; outline: none; resize: vertical; min-height: 40px; background: #fff; }
        .print-result { display: none; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 12px; }

        /* --- Buttons and Controls --- */
        .btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .btn-add-row, .btn-save, .btn-download, .btn-back, .btn-print { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; }
        .btn-add-row { background: #1a73e8; }
        .btn-save { background: #28a745; }
        .btn-download { background: #6f42c1; }
        .btn-back { background: #6c757d; }
        .btn-print { background: #007bff; }
        .message-box { background: #ffc107; color: #333; padding: 10px; border-radius: 4px; text-align: center; margin-bottom: 15px; display: none; }
        .top-buttons { display: flex; justify-content: space-between; margin-bottom: 15px; }

        /* --- Footer and Signature --- */
        .report-footer { margin-top: 30px; font-size: 14px; border-top: 2px solid #e0e0e0; padding-top: 20px; }
        .footer-signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .signature-block { display: flex; flex-direction: column; align-items: flex-start; }
        .signature-label { margin-bottom: 5px; font-weight: bold; }
        .signature-content select { padding: 5px 10px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 5px; width: 100%; max-width: 200px; }
        
        /* Print media query */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; border: none; }
            .btn-row, .top-buttons, .edit-area, .signature-content select, .remove-btn { display: none !important; }
            .print-result { display: block !important; white-space: pre-wrap; font-size: 14px; padding: 4px 0; margin: 0; min-height: 1.4em; }
            .subtest-table tr:has(.print-result:empty) { display: none; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="messageBox" class="message-box"></div>
        <div class="top-buttons">
            <button class="btn-back" onclick="goToDashboard()">‚Üê Back to Dashboard</button>
            <button class="btn-print" onclick="prepareAndPrint()">üñ®Ô∏è Print Report</button>
        </div>

        <h1>Patient Report Editor</h1>

        <div class="info-grid">
            <div class="info-item"><span>Patient Name:</span><span id="patientName">---</span></div>
            <div class="info-item"><span>Sample ID:</span><span id="sampleId">---</span></div>
            <div class="info-item"><span>Age/Gender:</span><span id="ageGender">---</span></div>
            <div class="info-item"><span>Contact No:</span><span id="contact">---</span></div>
            <div class="info-item"><span>Referred By:</span><span id="referredBy">---</span></div>
            <div class="info-item"><span>Test Name:</span><span id="testName">---</span></div>
            <div class="info-item"><span>Collection Date:</span><span id="collectionDate">---</span></div>
            <div class="info-item"><span>Report Date:</span><span id="reportDate">---</span></div>
        </div>

        <h2 class="histopathalogy-header">Histopathalogy Report</h2>

        <table class="subtest-table">
            <thead>
                <tr>
                    <th>Sub Test</th>
                    <th>Result/Finding</th>
                </tr>
            </thead>
            <tbody id="subtestBody"></tbody>
        </table>

        <div class="btn-row">
            <button class="btn-add-row" onclick="addRow()">+ Add New Row</button>
            <button class="btn-save" onclick="saveReport()">üíæ Save Report</button>
            <button class="btn-download" onclick="downloadReport()">‚¨áÔ∏è Download PDF</button>
        </div>

        <div class="report-footer">
            <div class="footer-signatures">
                <div class="signature-block">
                    <div class="signature-label">Report Checked By</div>
                    <div class="signature-content">
                        <select id="reportCheckedBy" onchange="toggleSignature()">
                            <option value="">-- Select Doctor --</option>
                            <option value="Dr. Alina Tiwari">Dr. Alina Tiwari</option>
                        </select>
                        <img id="signatureImage" src="Signature.jpg" alt="Signature" style="display:none;">
                    </div>
                    <div class="signature-content">
                        <div id="checkedByName">---</div>
                        <div id="checkedByTitle">---</div>
                        <div id="checkedByNMC">---</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedPatient = null;
        let patientId = null;

        const defaultPatientData = {
            firstName: "John", lastName: "Doe", age: "30", sex: "Male", contact: "98XXXXXXXX",
            referredBy: "City General Hospital", 
            testName: "Biopsy Report", sampleNumber: "Histo-2025-001", dateCollected: "2025-11-10",
            reportDate: new Date().toISOString().split('T')[0],
            subtestData: { "Clinical History": { value: "Patient presented with typical symptoms." }, "Microscopic Findings": { value: "Benign tissue fragments identified." }, },
            checkedBy: "Dr. Alina Tiwari"
        };
        
        // --- Core Data Functions ---

        /** Loads patient data and previous results from localStorage. */
        function loadPatient() {
            const stored = localStorage.getItem("selectedPatient");
            selectedPatient = stored ? JSON.parse(stored) : defaultPatientData;

            patientId = selectedPatient.sampleNumber || selectedPatient.id || 'default';

            // --- Populate Info Grid ---
            document.getElementById("patientName").textContent = selectedPatient.firstName + ' ' + selectedPatient.lastName;
            document.getElementById("ageGender").textContent = selectedPatient.age + ' / ' + selectedPatient.sex;
            document.getElementById("contact").textContent = selectedPatient.contact || "---";
            document.getElementById("sampleId").textContent = selectedPatient.sampleNumber || "---";

            // **THE FIX:** This pulls the updated hospital name from localStorage
            document.getElementById("referredBy").textContent = selectedPatient.referredBy || "---";
            
            document.getElementById("testName").textContent = selectedPatient.testName || "---";
            document.getElementById("collectionDate").textContent = formatDate(selectedPatient.dateCollected) || "---";
            document.getElementById("reportDate").textContent = formatDate(selectedPatient.reportDate) || "---";
            
            document.getElementById("reportCheckedBy").value = selectedPatient.checkedBy || "";
            toggleSignature();


            // --- Load Subtest Data ---
            const subtests = selectedPatient.subtestData || {};
            const tbody = document.getElementById('subtestBody');
            tbody.innerHTML = '';
            for (const [name, data] of Object.entries(subtests)) {
                addRow(name, data.value || "");
            }
            if (Object.keys(subtests).length < 4) {
                 addRow("Conclusion");
            }
        }
        
        // --- Utility/Helper Functions (Simplified for brevity) ---

        function formatDate(dateString) { /* ... implementation ... */ return dateString; }
        function goToDashboard() { 
            window.location.href = 'dashboard.html'; // Directs to the dashboard file
        }
        function toggleSignature() { /* ... implementation ... */ }
        function removeRow() { /* ... implementation ... */ }
        function addRow(name = "New Sub Test", value = "") {
            const tbody = document.getElementById('subtestBody');
            const row = tbody.insertRow();
            row.insertCell().innerHTML = `${name} <button class="remove-btn" onclick="removeRow(this)">Remove</button>`;
            row.insertCell().innerHTML = `<textarea class="edit-area" placeholder="Enter result">${value}</textarea><div class="print-result">${value}</div>`;
        }
        function syncPrintViews() { /* ... implementation ... */ }
        function saveReport() { /* ... implementation ... */ alert("Report saved!"); }
        function prepareAndPrint() { /* ... implementation ... */ window.print(); }
        function downloadReport() { /* ... implementation ... */ alert("PDF download simulated."); }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPatient();
        });
    </script>
</body>
</html>