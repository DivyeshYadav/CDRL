<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Details - Lab Report</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        @page {
            size: A4;
            margin: 15mm;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f4f6f8;
        }

        .container {
            max-width: 800px;
            margin: 30px auto;
            background: #fff;
            padding: 25px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 22px;
            color: #007bff;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px 20px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ccc;
            padding-bottom: 3px;
        }

        .info-item span {
            font-weight: bold;
        }

        .subtest-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }

        .subtest-table th,
        .subtest-table td {
            border: 1px solid #999;
            padding: 6px;
        }

        .subtest-table th {
            background-color: #f0f0f0;
        }

        input[type="text"] {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 13px;
            outline: none;
        }

        /* Footer section */
        .report-footer {
            margin-top: 30px;
            font-size: 13px;
            border: 1px solid #999;
            border-radius: 6px;
            padding: 10px;
        }

        .report-footer select {
            padding: 3px 6px;
            font-size: 13px;
            margin-top: 4px;
        }

        .signature-box img {
            width: 80px;
            display: none;
            margin-top: 5px;
        }

        /* Top Buttons */
        .top-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        /* Save Button */
        .btn-save {
            background: #28a745;
        }

        .btn-row {
            text-align: right;
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .top-buttons button,
        .btn-row button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: white;
            transition: background 0.2s;
        }

        .btn-print {
            background: #007bff;
        }

        .btn-print:hover {
            background: #0056b3;
        }

        .btn-back {
            background: #6c757d;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .btn-row,
            .top-buttons,
            select {
                display: none !important;
            }

            .container {
                border: none;
                box-shadow: none;
                margin: 0;
                width: 100%;
                padding: 0;
            }

            input[type="text"] {
                border: none;
            }

            .print-result {
                /* Ensures the printed text looks clean */
                display: block;
                padding: 4px 0;
            }

            .signature-box img {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="top-buttons">
            <button class="btn-back" onclick="goBack()">‚Üê Back to Dashboard</button>
            <button class="btn-print" onclick="prepareAndPrint()">üñ®Ô∏è Print</button>
        </div>

        <h1>Patient Details</h1>

        <div class="info-grid">
            <div class="info-item"><span>Patient Name:</span> <span id="patientName">---</span></div>
            <div class="info-item"><span>Sample ID:</span> <span id="sampleId">---</span></div>
            <div class="info-item"><span>Age/Gender:</span> <span id="ageGender">---</span></div>
            <div class="info-item"><span>Contact No:</span> <span id="contact">---</span></div>
            <div class="info-item"><span>Referred By:</span> <span id="referredBy">---</span></div>
            <div class="info-item"><span>Requested By:</span> <span id="requestedBy">---</span></div>
            <div class="info-item"><span>Date of Collection:</span> <span id="collectionDate">---</span></div>
            <div class="info-item"><span>Date of Registration:</span> <span id="registrationDate">---</span></div>
            <div class="info-item"><span>Date of Reporting:</span> <span id="reportDate">---</span></div>
        </div>

        <table class="subtest-table" id="reportSubtests">
            <thead>
                <tr>
                    <th>Sub Test</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Chief Complaint</td>
                    <td><input type="text" id="chiefComplaint" data-subtest-name="Chief Complaint"
                            placeholder="Enter result"></td>
                </tr>
                <tr>
                    <td>USG Findings</td>
                    <td><input type="text" id="usgFindings" data-subtest-name="USG Findings" placeholder="Enter result">
                    </td>
                </tr>
                <tr>
                    <td>Gross</td>
                    <td><input type="text" id="gross" data-subtest-name="Gross" placeholder="Enter result"></td>
                </tr>
                <tr>
                    <td>Microscopy</td>
                    <td><input type="text" id="microscopy" data-subtest-name="Microscopy" placeholder="Enter result">
                    </td>
                </tr>
                <tr>
                    <td>Impression</td>
                    <td><input type="text" id="impression" data-subtest-name="Impression" placeholder="Enter result">
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="btn-row">
            <button class="btn-save" onclick="saveSubtest()">üíæ Save Results</button>
        </div>

        <div class="report-footer">
            <label><strong>Report Checked By:</strong></label>
            <div class="signature-box">
                <select id="reportCheckedBy" onchange="toggleSignature()">
                    <option value="">-- Select --</option>
                    <option value="Alina Tiwari">Alina Tiwari</option>
                </select>
                <img id="signatureImage" src="Signature.jpg" alt="Signature">
            </div>
            <p><strong>Consultant Pathologist</strong><br>NMC No: 23690</p>
        </div>
    </div>

    <script>
        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        // --- End Firebase Initialization ---

        const storedPatient = localStorage.getItem("selectedPatient");
        let selectedPatient = storedPatient ? JSON.parse(storedPatient) : null;

        function loadPatientData() {
            if (!selectedPatient) {
                alert("No patient selected! Redirecting to dashboard.");
                goBack();
                return;
            }

            const fullName = `${selectedPatient.firstName || ''} ${selectedPatient.middleName || ''} ${selectedPatient.lastName || ''}`.trim();

            // Populate Info Grid
            document.getElementById("patientName").textContent = fullName;
            document.getElementById("ageGender").textContent = `${selectedPatient.age || '---'} / ${selectedPatient.sex || '---'}`;
            document.getElementById("contact").textContent = selectedPatient.contact && selectedPatient.contact.trim() !== "" ? selectedPatient.contact : "0000000000";
            document.getElementById("referredBy").textContent = selectedPatient.referredBy || '---';
            document.getElementById("requestedBy").textContent = selectedPatient.requestedBy || '---';
            document.getElementById("collectionDate").textContent = selectedPatient.date || '---';
            document.getElementById("registrationDate").textContent = selectedPatient.date || '---';
            document.getElementById("reportDate").textContent = selectedPatient.date || '---';
            document.getElementById("sampleId").textContent = selectedPatient.sampleNumber || '---';

            // Load existing subtest data into input fields
            if (selectedPatient.subtestData) {
                document.getElementById('chiefComplaint').value = selectedPatient.subtestData['Chief Complaint']?.value || '';
                document.getElementById('usgFindings').value = selectedPatient.subtestData['USG Findings']?.value || '';
                document.getElementById('gross').value = selectedPatient.subtestData['Gross']?.value || '';
                document.getElementById('microscopy').value = selectedPatient.subtestData['Microscopy']?.value || '';
                document.getElementById('impression').value = selectedPatient.subtestData['Impression']?.value || '';
            }
        }

        function saveSubtest() {
            if (!selectedPatient || !selectedPatient.id) {
                alert("Cannot save: Missing patient ID. Please return to the dashboard and re-select the patient.");
                return;
            }

            const newSubtestData = {};
            const inputs = document.querySelectorAll('#reportSubtests input[type="text"]');

            inputs.forEach(input => {
                const subtestName = input.getAttribute('data-subtest-name');
                const value = input.value.trim();

                if (value !== "") {
                    newSubtestData[subtestName] = { value: value };
                }
            });

            // 1. Update Firestore
            db.collection("patients").doc(selectedPatient.id).update({
                subtestData: newSubtestData
            })
                .then(() => {
                    alert("Report results saved successfully to the cloud!");

                    // 2. Update local data and storage
                    selectedPatient.subtestData = newSubtestData;
                    localStorage.setItem("selectedPatient", JSON.stringify(selectedPatient));
                })
                .catch(error => {
                    console.error("Error updating document: ", error);
                    alert("Failed to save data. Check console for details.");
                });
        }

        function toggleSignature() {
            const sel = document.getElementById("reportCheckedBy");
            const img = document.getElementById("signatureImage");
            img.style.display = sel.value ? "block" : "none";
        }

        // **CRUCIAL BACK NAVIGATION FIX:** Sets the flag for the dashboard to read
        // In patient_details.html
        function goBack() {
            // This string 'reportEntry' MUST match the string used in dashboard.html
            localStorage.setItem('dashboardView', 'reportEntry');
            // This file name MUST be correct
            window.location.href = "dashboard.html";
         }

        function prepareAndPrint() {
            const inputs = document.querySelectorAll("#reportSubtests input[type='text']");

            // 1. Store original cell content and hide empty rows
            const originalContents = [];

            inputs.forEach(input => {
                const row = input.closest('tr');
                // Store original HTML and display state
                originalContents.push({ row, originalHTML: input.parentNode.innerHTML, originalDisplay: row.style.display });

                if (!input.value.trim()) {
                    // Hide the row if the input is empty for printing
                    row.style.display = "none";
                } else {
                    // Replace input with static text for printing
                    const resultCell = input.parentNode;
                    const resultSpan = document.createElement('span');
                    resultSpan.textContent = input.value;
                    resultSpan.className = 'print-result';
                    resultCell.innerHTML = ''; // Clear cell
                    resultCell.appendChild(resultSpan);
                    row.style.display = "table-row"; // Ensure non-empty rows are visible
                }
            });

            // 2. Print
            window.print();

            // 3. Restore the original input fields and row visibility after printing
            originalContents.forEach(({ row, originalHTML, originalDisplay }) => {
                row.querySelector('td:last-child').innerHTML = originalHTML;
                row.style.display = originalDisplay;
            });
            // Re-run load to ensure any dynamically created inputs are attached to event handlers/reloaded
            loadPatientData();
        }

        document.addEventListener('DOMContentLoaded', loadPatientData);
    </script>
</body>

</html>