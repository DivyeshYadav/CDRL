<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @page {
            size: A4;
            margin: 15mm;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
            color: #1a73e8;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .histopathalogy-header {
            text-align: center;
            margin: 20px 0 15px 0;
            font-size: 18px;
            color: #1a73e8;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            font-weight: bold;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 25px;
            margin-bottom: 25px;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
        }

        .info-item span:first-child {
            font-weight: 500;
            color: #555;
        }

        .info-item span:last-child {
            font-weight: bold;
            color: #333;
        }

        .subtest-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .subtest-table th,
        .subtest-table td {
            border: 1px solid #dcdcdc;
            padding: 8px;
            vertical-align: top;
        }

        .subtest-table th {
            background: #eaf1fb;
            font-weight: bold;
            text-align: left;
        }

        .subtest-name-cell {
            font-weight: 600;
            background: #f7f9fc;
            cursor: text;
        }

        .subtest-name-cell:focus {
            outline: 2px solid #1a73e8;
            background: #fff;
        }

        .edit-area {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 14px;
            outline: none;
            resize: vertical;
            min-height: 40px;
            background: #fff;
        }

        .print-result {
            display: none;
        }

        .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-add-row {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-save {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-print {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-download {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .message-box {
            background: #ffc107;
            color: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .top-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        /* Footer Styling */
        .report-footer {
            margin-top: 30px;
            font-size: 14px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }

        .footer-signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .signature-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .signature-label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .signature-content {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .signature-content select {
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
            width: 100%;
            max-width: 200px;
        }

        .signature-content img {
            width: 120px;
            max-height: 40px;
            object-fit: contain;
            display: none;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            @page {
                margin-top: 30mm;
                /* Add top margin for printed page */
            }

            .container {
                max-width: none;
                width: 100%;
                margin: 0;
                padding: 15px;
                box-shadow: none;
                border: none;
                margin-top: 20mm !important;
            }

            .btn-row,
            .top-buttons,
            .edit-area,
            .signature-content select {
                display: none !important;
            }

            .print-result {
                display: block !important;
                white-space: pre-wrap;
                font-size: 14px;
                padding: 4px 0;
                margin: 0;
                min-height: 1.4em;
            }

            .subtest-table tr:has(.print-result:empty) {
                display: none;
            }

            .subtest-table td {
                border-color: #555 !important;
            }

            .signature-content img {
                display: block !important;
            }

            .footer-signatures {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="messageBox" class="message-box"></div>
        <div class="top-buttons">
            <button class="btn-back" onclick="goToDashboard()">‚Üê Back to Dashboard</button>
            <button class="btn-print" onclick="prepareAndPrint()">üñ®Ô∏è Print Report</button>
        </div>

        <h1>Patient Report Editor</h1>

        <div class="info-grid">
            <div class="info-item"><span>Patient Name:</span><span id="patientName">---</span></div>
            <div class="info-item"><span>Sample ID:</span><span id="sampleId">---</span></div>
            <div class="info-item"><span>Age/Gender:</span><span id="ageGender">---</span></div>
            <div class="info-item"><span>Contact No:</span><span id="contact">---</span></div>
            <div class="info-item"><span>Referred By:</span><span id="referredBy">---</span></div>
            <div class="info-item"><span>Test Name:</span><span id="testName">---</span></div>
            <div class="info-item"><span>Collection Date:</span><span id="collectionDate">---</span></div>
            <div class="info-item"><span>Report Date:</span><span id="reportDate">---</span></div>
        </div>

        <h2 class="histopathalogy-header">Histopathalogy</h2>

        <table class="subtest-table">
            <thead>
                <tr>
                    <th>Sub Test</th>
                    <th>Result/Finding</th>
                </tr>
            </thead>
            <tbody id="subtestBody"></tbody>
        </table>

        <div class="btn-row">
            <button class="btn-add-row" onclick="addRow()">+ Add New Row</button>
            <button class="btn-save" onclick="saveReport()">üíæ Save Report</button>
            <button class="btn-download" onclick="downloadReport()">‚¨áÔ∏è Download PDF</button>
        </div>

        <div class="report-footer">
            <div class="footer-signatures">
                <div class="signature-block">
                    <div class="signature-label">
                        <div class="signature-label">Report Checked By</div>
                        <div class="signature-content">
                            <select id="reportCheckedBy" onchange="toggleSignature()">
                                <option value="">-- Select Doctor --</option>
                                <option value="Dr. Alina Tiwari">Dr. Alina Tiwari</option>
                            </select>
                            <img id="signatureImage" src="Signature.jpg" alt="Signature">
                        </div>
                        <div class="signature-content">
                            <div>Dr. Alina Tiwari</div>
                            <div>Consultant Pathalogist</div>
                            <div>NMC No: 23690</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedPatient = null;
        let patientId = null;
        const { jsPDF } = window.jspdf;

        function displayMessage(msg) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 4000);
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function toggleSignature() {
            const doctor = document.getElementById("reportCheckedBy").value;
            document.getElementById("signatureImage").style.display = doctor ? "block" : "none";
        }

        function addRow(name = "New Sub Test", value = "") {
            const tbody = document.getElementById('subtestBody');
            const row = tbody.insertRow();

            const nameCell = row.insertCell();
            nameCell.className = 'subtest-name-cell';
            nameCell.contentEditable = true;
            nameCell.textContent = name;

            const resultCell = row.insertCell();
            resultCell.innerHTML = `
                <textarea class="edit-area" placeholder="Enter result">${value}</textarea>
                <div class="print-result">${value}</div>
            `;
        }

        function syncPrintViews() {
            document.querySelectorAll('#subtestBody tr').forEach(row => {
                const textarea = row.querySelector('.edit-area');
                const printDiv = row.querySelector('.print-result');
                if (textarea && printDiv) {
                    printDiv.textContent = textarea.value;
                }
            });
        }

        function saveReport() {
            syncPrintViews();

            const rows = document.querySelectorAll("#subtestBody tr");
            const subtests = {};
            rows.forEach(row => {
                const name = row.cells[0].textContent.trim();
                const value = row.querySelector('.edit-area').value.trim();
                if (name) {
                    subtests[name] = { value };
                }
            });

            const checkedBy = document.getElementById('reportCheckedBy').value;
            const reportDate = new Date().toISOString().split('T')[0];

            if (patientId) {
                localStorage.setItem(`subtests_${patientId}`, JSON.stringify(subtests));
                localStorage.setItem(`checkedBy_${patientId}`, checkedBy);
                localStorage.setItem(`reportDate_${patientId}`, reportDate);

                selectedPatient = {
                    ...selectedPatient,
                    subtestData: subtests,
                    checkedBy,
                    reportDate
                };
                localStorage.setItem("selectedPatient", JSON.stringify(selectedPatient));

                displayMessage("Report saved successfully!");
            } else {
                displayMessage("Error: No patient ID found for saving");
            }
        }

        function prepareAndPrint() {
            syncPrintViews();

            const hasContent = Array.from(document.querySelectorAll('.print-result'))
                .some(div => div.textContent.trim() !== '');

            if (!hasContent) {
                displayMessage("‚ö†Ô∏è No results entered. Nothing to print.");
                return;
            }

            window.print();
        }

        function downloadReport() {
            syncPrintViews();

            const hasContent = Array.from(document.querySelectorAll('.print-result'))
                .some(div => div.textContent.trim() !== '');

            if (!hasContent) {
                displayMessage("‚ö†Ô∏è No results entered. Nothing to download.");
                return;
            }

            // Create a temporary element to hold the print content
            const printElement = document.createElement('div');
            printElement.id = 'pdf-content';
            printElement.innerHTML = `
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 0;
                        padding: 0;
                        background: white;
                    }
                    .pdf-container {
                        width: 210mm;
                        height: 297mm;
                        padding: 15mm;
                        box-sizing: border-box;
                        font-size: 10pt;
                        line-height: 1.4;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 15px;
                        padding-bottom: 10px;
                        /* Border removed */
                    }
                    .header h1 {
                        color: #1a73e8;
                        font-size: 16pt;
                        margin: 0;
                        font-weight: bold;
                    }
                    .info-section {
                        margin-bottom: 15px;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 5px;
                    }
                    .info-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 8px;
                        font-size: 10pt;
                    }
                    .info-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 4px 0;
                        border-bottom: 1px solid #eee;
                    }
                    .info-item span:first-child {
                        font-weight: 600;
                        color: #333;
                        min-width: 100px;
                    }
                    .info-item span:last-child {
                        font-weight: normal;
                        color: #000;
                        word-break: break-word;
                    }
                    .results-header {
                        text-align: center;
                        margin: 20px 0 15px 0;
                        font-size: 14pt;
                        color: #1a73e8;
                        /* Border removed */
                        padding-bottom: 8px;
                        font-weight: bold;
                    }
                    .results-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                        font-size: 10pt;
                    }
                    .results-table th {
                        background: #eaf1fb;
                        font-weight: bold;
                        text-align: left;
                        padding: 8px;
                        border: 1px solid #ddd;
                    }
                    .results-table td {
                        padding: 8px;
                        border: 1px solid #ddd;
                        vertical-align: top;
                        word-break: break-word;
                    }
                    .footer {
                        margin-top: 30px;
                        padding-top: 15px;
                        /* Border removed */
                        font-size: 10pt;
                    }
                    .signature {
                        margin-top: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        gap: 30px;
                    }
                    .signature-block {
                        flex: 1;
                        min-width: 200px;
                    }
                    .signature-title {
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    .signature-content {
                        margin-top: 5px;
                    }
                </style>
                <div class="pdf-container">
                    
                    <div class="header">
                    </div>
                    
                    <div class="info-section">
                        <div class="info-grid">
                            <div class="info-item">
                                <span>Patient Name:</span>
                                <span>` + document.getElementById("patientName").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Sample ID:</span>
                                <span>` + document.getElementById("sampleId").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Age/Gender:</span>
                                <span>` + document.getElementById("ageGender").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Contact No:</span>
                                <span>` + document.getElementById("contact").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Referred By:</span>
                                <span>` + document.getElementById("referredBy").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Test Name:</span>
                                <span>` + document.getElementById("testName").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Collection Date:</span>
                                <span>` + document.getElementById("collectionDate").textContent + `</span>
                            </div>
                            <div class="info-item">
                                <span>Report Date:</span>
                                <span>` + document.getElementById("reportDate").textContent + `</span>
                            </div>
                        </div>
                    </div>

                    <h1 class="results-header">Histopathalogy</h1>

                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Sub Test</th>
                                <th>Result/Finding</th>
                            </tr>
                        </thead>
                        <tbody>
                            ` + Array.from(document.querySelectorAll('#subtestBody tr'))
                    .map(row => {
                        const name = row.cells[0].textContent;
                        const result = row.querySelector('.print-result').textContent;
                        return '<tr><td style="width: 30%;">' + name + '</td><td style="width: 70%;">' + result + '</td></tr>';
                    }).join('') + `
                        </tbody>
                    </table>

                    <div class="footer">
                        <div class="signature">
                            <div class="signature-block">
                                <div class="signature-title">Report Checked By</div>
                                <div class="signature-content">
                                    <div>` + (document.getElementById("reportCheckedBy").value || '---') + `</div>
                                    ` + (document.getElementById("reportCheckedBy").value ? '<img src="Signature.jpg" alt="Signature" style="width: 120px; max-height: 40px; object-fit: contain; display: block;">' : '') + `
                                </div>
                                <div class="signature-content">
                                    <div>Dr. Alina Tiwari</div>
                                    <div>Consultant Pathologist</div>
                                    <div>NMC No: 23690</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(printElement);

            // Use html2canvas to capture the content
            html2canvas(printElement, {
                scale: 2,
                useCORS: true,
                logging: false,
                width: 210 * 4,
                height: 297 * 4,
                scrollY: 0
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Set top margin for the PDF
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const marginTop = 10;

                // Only add image if it fits or split across pages
                if (imgHeight <= pageHeight - marginTop) {
                    // Single page
                    pdf.addImage(imgData, 'PNG', 0, marginTop, imgWidth, imgHeight);
                } else {
                    // Handle multi-page if needed
                    pdf.addImage(imgData, 'PNG', 0, marginTop, imgWidth, imgHeight);
                }

                // Generate filename
                const patientName = document.getElementById("patientName").textContent.replace(/\s+/g, '_');
                const fileName = 'CDRL_Report_' + patientName + '_' + new Date().toISOString().split('T')[0] + '.pdf';

                pdf.save(fileName);
                document.body.removeChild(printElement);
            }).catch(err => {
                console.error('Error generating PDF:', err);
                displayMessage("Error generating PDF. Please try again.");
            });
        }

        function loadPatient() {
            const stored = localStorage.getItem("selectedPatient");
            selectedPatient = stored ? JSON.parse(stored) : {
                firstName: "John",
                lastName: "Doe",
                age: "30",
                sex: "Male",
                contact: "",
                referredBy: "",
                testName: "",
                sampleNumber: "S-001",
                dateCollected: "2025-11-10",
                reportDate: "2025-11-17",
                subtestData: {
                    "Chief Complaint": { value: "" },
                    "USG Findings": { value: "" },
                    "Gross": { value: "" },
                    "Microscopy": { value: "" },
                    "Impression": { value: "" }
                }
            };

            patientId = selectedPatient.sampleNumber || selectedPatient.id || 'default';

            const storedSubtests = localStorage.getItem(`subtests_${patientId}`);
            const storedCheckedBy = localStorage.getItem(`checkedBy_${patientId}`);
            const storedReportDate = localStorage.getItem(`reportDate_${patientId}`);

            if (storedSubtests) {
                selectedPatient.subtestData = JSON.parse(storedSubtests);
            }
            if (storedCheckedBy) {
                selectedPatient.checkedBy = storedCheckedBy;
            }
            if (storedReportDate) {
                selectedPatient.reportDate = storedReportDate;
            }

            document.getElementById("patientName").textContent = selectedPatient.firstName + ' ' + selectedPatient.lastName;
            document.getElementById("ageGender").textContent = selectedPatient.age + ' / ' + selectedPatient.sex;
            document.getElementById("contact").textContent = selectedPatient.contact || "---";
            document.getElementById("referredBy").textContent = selectedPatient.referredBy || "---";
            document.getElementById("testName").textContent = selectedPatient.testName || "---";
            document.getElementById("collectionDate").textContent = selectedPatient.dateCollected || "---";
            document.getElementById("reportDate").textContent = selectedPatient.reportDate || "---";
            document.getElementById("sampleId").textContent = selectedPatient.sampleNumber || "---";
            document.getElementById("reportCheckedBy").value = selectedPatient.checkedBy || "";
            toggleSignature();

            const tbody = document.getElementById('subtestBody');
            tbody.innerHTML = '';
            const subtests = selectedPatient.subtestData || {};
            for (const [name, data] of Object.entries(subtests)) {
                addRow(name, data.value || "");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPatient();

            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('edit-area')) {
                    const printDiv = e.target.parentElement.querySelector('.print-result');
                    if (printDiv) printDiv.textContent = e.target.value;
                }
            });
        });
    </script>
</body>

</html>